<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EMR Diagnosis Entry (NAMASTE + ICD-11)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border-left-color: #09f;
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-5xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-teal-700">EMR Dual-Coding Diagnosis Entry</h1>
            <p class="text-gray-600 mt-2">Integrating NAMASTE (Ayurveda, Siddha, Unani) with ICD-11</p>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold mb-4 border-b pb-2">1. Select Patient</h2>
                <div class="relative">
                    <input type="text" id="patientSearchInput" placeholder="Search for a patient by name or DOB..." class="w-full p-2 border rounded-md focus:ring-2 focus:ring-teal-500 focus:outline-none">
                    <div id="patientResults" class="mt-2 bg-white border rounded-md shadow-lg max-h-60 overflow-y-auto hidden"></div>
                </div>
                <div id="selectedPatient" class="mt-4 hidden p-3 bg-teal-50 rounded-md"></div>


                <h2 class="text-xl font-semibold mt-6 mb-4 border-b pb-2">2. Add Diagnosis</h2>
                <div class="relative">
                    <input type="text" id="searchInput" placeholder="Search for a condition (e.g., 'Vataja Jvara')" class="w-full p-2 border rounded-md focus:ring-2 focus:ring-teal-500 focus:outline-none">
                    <div id="spinner" class="spinner absolute right-3 top-2 hidden"></div>
                </div>
                <div id="results" class="mt-2 bg-white border rounded-md shadow-lg max-h-60 overflow-y-auto hidden"></div>
                
                <h2 class="text-xl font-semibold mt-6 mb-4 border-b pb-2">3. Problem List</h2>
                <ul id="problemList" class="space-y-2">
                    <li id="empty-list-item" class="text-gray-500">No diagnoses added yet.</li>
                </ul>
                <button id="submitBtn" class="w-full bg-teal-600 text-white font-bold py-2 px-4 rounded-md hover:bg-teal-700 transition duration-300 mt-6">Generate & Submit FHIR Bundle</button>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-md">
                <div class="flex justify-between items-center mb-2 border-b pb-2">
                    <h2 class="text-xl font-semibold">4. FHIR Bundle Output</h2>
                    <button id="downloadBtn" class="bg-blue-500 text-white font-bold py-1 px-3 rounded-md hover:bg-blue-600 transition duration-300 disabled:bg-gray-400" disabled>Download .txt</button>
                </div>
                <p class="text-sm text-gray-500 mb-4">The generated FHIR transaction bundle will appear here.</p>
                <pre id="fhirOutput" class="bg-gray-800 text-white text-sm p-4 rounded-md h-64 overflow-auto">{}</pre>
                
                <h2 class="text-xl font-semibold mt-6 mb-2 border-b pb-2">5. Server Response</h2>
                 <p class="text-sm text-gray-500 mb-4">The API server's response will appear here.</p>
                <pre id="serverResponse" class="bg-gray-200 text-sm p-4 rounded-md h-48 overflow-auto"></pre>
            </div>
        </div>
    </div>

    <script>
        // DOM Elements
        const searchInput = document.getElementById('searchInput');
        const resultsEl = document.getElementById('results');
        const problemListEl = document.getElementById('problemList');
        const fhirOutput = document.getElementById('fhirOutput');
        const serverResponseEl = document.getElementById('serverResponse');
        const submitBtn = document.getElementById('submitBtn');
        const spinner = document.getElementById('spinner');
        const emptyListItem = document.getElementById('empty-list-item');
        const downloadBtn = document.getElementById('downloadBtn');
        const patientSearchInput = document.getElementById('patientSearchInput');
        const patientResultsEl = document.getElementById('patientResults');
        const selectedPatientEl = document.getElementById('selectedPatient');

        // Configuration
        const API_BASE_URL = window.location.origin;
        const MOCK_ABHA_TOKEN = 'mock-jwt-token-for-abha-user';
        let problemList = [];
        let selectedPatient = null;
        let searchTimeout;
        let patientSearchTimeout;

        // Event Listeners
        patientSearchInput.addEventListener('input', () => {
            clearTimeout(patientSearchTimeout);
            const query = patientSearchInput.value.trim();
            if (query.length < 1) {
                patientResultsEl.classList.add('hidden');
                return;
            }
            patientSearchTimeout = setTimeout(() => searchPatients(query), 300);
        });

        searchInput.addEventListener('input', () => {
            clearTimeout(searchTimeout);
            const query = searchInput.value.trim();
            if (query.length < 2) {
                resultsEl.innerHTML = '';
                resultsEl.classList.add('hidden');
                return;
            }
            spinner.classList.remove('hidden');
            searchTimeout = setTimeout(() => {
                search(query);
            }, 300);
        });

        submitBtn.addEventListener('click', handleSubmit);
        downloadBtn.addEventListener('click', downloadBundleAsTxt);

        // --- Patient Search and Selection ---
        async function searchPatients(query) {
             try {
                const response = await fetch(`${API_BASE_URL}/api/patients?q=${encodeURIComponent(query)}`);
                const data = await response.json();
                displayPatientResults(data);
            } catch (error) {
                console.error('Patient search failed:', error);
                patientResultsEl.innerHTML = `<div class="p-2 text-red-500">Search failed.</div>`;
                patientResultsEl.classList.remove('hidden');
            }
        }

        function displayPatientResults(patients) {
            if (patients.length === 0) {
                patientResultsEl.innerHTML = `<div class="p-2 text-gray-500">No patients found.</div>`;
            } else {
                patientResultsEl.innerHTML = patients.map(p => `
                    <div class="p-3 hover:bg-teal-100 cursor-pointer border-b last:border-b-0" 
                         onclick='selectPatient(${JSON.stringify(p)})'>
                        <p class="font-semibold">${p.patient_name}</p>
                        <p class="text-sm text-gray-600">DOB: ${p.dob}</p>
                    </div>
                `).join('');
            }
            patientResultsEl.classList.remove('hidden');
        }

        function selectPatient(patient) {
            selectedPatient = patient;
            patientSearchInput.value = '';
            patientResultsEl.classList.add('hidden');
            selectedPatientEl.innerHTML = `Selected: <strong class="text-teal-700">${patient.patient_name}</strong> (DOB: ${patient.dob})`;
            selectedPatientEl.classList.remove('hidden');
        }


        // --- Formatting and Download ---
        function formatBundleForTxt(bundle) {
            if (!bundle || !bundle.entry) {
                return "Invalid bundle data.";
            }

            const patientEntry = bundle.entry.find(e => e.resource.resourceType === 'Patient');
            const patientName = patientEntry ? patientEntry.resource.name[0].text : 'Unknown Patient';
            const patientDob = patientEntry && patientEntry.resource.birthDate ? patientEntry.resource.birthDate : 'N/A';
            
            let output = `NAME: ${patientName}\nDOB: ${patientDob}\n\n`;

            const conditions = bundle.entry
                .filter(e => e.resource.resourceType === 'Condition')
                .map(e => {
                    const namasteCoding = e.resource.code.coding.find(c => c.system === 'http://namaste-dt.gov.in');
                    const icd11Coding = e.resource.code.coding.find(c => c.system === 'http://id.who.int/icd/release/11/mms');
                    
                    const namasteDisplay = namasteCoding ? namasteCoding.display : 'N/A';
                    const icd11Display = icd11Coding ? icd11Coding.display : 'N/A';

                    return `NAMASTE CODE: ${namasteDisplay}\nICD CODE: ${icd11Display}`;
                })
                .join('\n\n');

            return output + conditions;
        }

        function downloadBundleAsTxt() {
            const bundleText = fhirOutput.textContent;
            if (bundleText === '{}' || !bundleText) {
                console.warn("No bundle content to download.");
                return;
            }

            const bundleObject = JSON.parse(bundleText);
            const formattedText = formatBundleForTxt(bundleObject);
            const blob = new Blob([formattedText], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = `patient-summary-${new Date().toISOString().replace(/:/g, '-')}.txt`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }

        // --- Core Functions ---

        async function search(query) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/lookup?q=${encodeURIComponent(query)}`);
                const data = await response.json();
                displayResults(data, query);
            } catch (error) {
                console.error('Search failed:', error);
                resultsEl.innerHTML = `<div class="p-2 text-red-500">Search failed.</div>`;
                resultsEl.classList.remove('hidden');
            } finally {
                spinner.classList.add('hidden');
            }
        }

        function displayResults(results, query) {
            if (results.length === 0) {
                resultsEl.innerHTML = `<div class="p-2 text-gray-500">No results found.</div>`;
            } else {
                const queryLower = query.toLowerCase();
                resultsEl.innerHTML = results.map(item => {
                    const icdDisplayLower = (item.icd11_display || '').toLowerCase();
                    const namasteDisplayLower = (item.namaste_display || '').toLowerCase();

                    if (icdDisplayLower.includes(queryLower) && !namasteDisplayLower.includes(queryLower)) {
                        return `
                            <div class="p-3 hover:bg-teal-100 cursor-pointer border-b last:border-b-0" 
                                 onclick='addProblem(${JSON.stringify(item)})'>
                                <p class="font-semibold text-teal-800">${item.icd11_display} (${item.icd11_code})</p>
                                <p class="text-sm text-gray-600">NAMASTE: ${item.namaste_display}</p>
                            </div>
                        `;
                    } else {
                        return `
                            <div class="p-3 hover:bg-teal-100 cursor-pointer border-b last:border-b-0" 
                                 onclick='addProblem(${JSON.stringify(item)})'>
                                <p class="font-semibold text-teal-800">${item.namaste_display}</p>
                                <p class="text-sm text-gray-600">ICD-11: ${item.icd11_display} (${item.icd11_code})</p>
                            </div>
                        `;
                    }
                }).join('');
            }
            resultsEl.classList.remove('hidden');
        }

        function addProblem(item) {
            problemList.push(item);
            searchInput.value = '';
            resultsEl.classList.add('hidden');
            renderProblemList();
        }

        function renderProblemList() {
             if (problemList.length > 0 && emptyListItem) {
                emptyListItem.style.display = 'none';
            } else if (problemList.length === 0 && emptyListItem) {
                emptyListItem.style.display = 'block';
            }

            problemListEl.innerHTML = problemList.map((item, index) => `
                <li class="flex justify-between items-center p-2 bg-teal-50 rounded-md">
                    <div>
                        <p class="font-semibold text-teal-800">${item.namaste_display}</p>
                        <p class="text-sm text-gray-600">ICD-11: ${item.icd11_display}</p>
                    </div>
                    <button onclick="removeProblem(${index})" class="text-red-500 hover:text-red-700 font-bold text-lg">&times;</button>
                </li>
            `).join('');
            if (problemList.length === 0) {
                 problemListEl.appendChild(emptyListItem);
            }
        }
        
        function removeProblem(index) {
            problemList.splice(index, 1);
            renderProblemList();
        }

        function uuidv4() {
            return ([1e7] + -1e3 + -4e3 + -8e3 + -1e11).replace(/[018]/g, c =>
                (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
            );
        }

        function generateFhirBundle() {
            const patientId = selectedPatient ? selectedPatient.patient_id : uuidv4();
            const patientName = selectedPatient ? selectedPatient.patient_name : 'Anonymous Patient';
            const practitionerId = uuidv4();
            const patientFullUrl = `urn:uuid:${patientId}`;
            const practitionerFullUrl = `urn:uuid:${practitionerId}`;
            
            const patientResource = {
                resourceType: 'Patient',
                name: [{ text: patientName }]
            };
            if (selectedPatient && selectedPatient.dob) {
                patientResource.birthDate = selectedPatient.dob;
            }


            const entries = [
                {
                    fullUrl: patientFullUrl,
                    resource: patientResource,
                    request: { method: 'POST', url: 'Patient' }
                },
                {
                    fullUrl: practitionerFullUrl,
                    resource: {
                        resourceType: 'Practitioner',
                        name: [{ text: 'Dr. Ayush' }]
                    },
                    request: { method: 'POST', url: 'Practitioner' }
                }
            ];

            problemList.forEach(problem => {
                const conditionId = uuidv4();
                entries.push({
                    fullUrl: `urn:uuid:${conditionId}`,
                    resource: {
                        resourceType: 'Condition',
                        subject: { reference: patientFullUrl },
                        asserter: { reference: practitionerFullUrl },
                        code: {
                            coding: [
                                { system: 'http://namaste-dt.gov.in', code: problem.namaste_code, display: problem.namaste_display },
                                { system: 'http://id.who.int/icd/release/11/mms', code: problem.icd11_code, display: problem.icd11_display }
                            ],
                            text: problem.namaste_display
                        }
                    },
                    request: { method: 'POST', url: 'Condition' }
                });
            });

            const bundle = {
                resourceType: 'Bundle',
                id: `urn:uuid:${uuidv4()}`,
                type: 'transaction',
                entry: entries
            };

            return bundle;
        }

        async function handleSubmit() {
            if (!selectedPatient) {
                alert("Please select a patient first.");
                return;
            }
            if (problemList.length === 0) {
                alert("Please add at least one diagnosis to the problem list.");
                return;
            }

            const bundle = generateFhirBundle();
            fhirOutput.textContent = JSON.stringify(bundle, null, 2);
            downloadBtn.disabled = false;
            serverResponseEl.textContent = 'Submitting...';
            serverResponseEl.classList.remove('text-red-500');

            try {
                const response = await fetch(`${API_BASE_URL}/fhir/Bundle`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${MOCK_ABHA_TOKEN}`
                    },
                    body: JSON.stringify(bundle)
                });
                const result = await response.json();
                serverResponseEl.textContent = JSON.stringify(result, null, 2);
                if (!response.ok) {
                    serverResponseEl.classList.add('text-red-500');
                }

            } catch (error) {
                console.error('Submit failed:', error);
                serverResponseEl.textContent = `Error: ${error.message}`;
                serverResponseEl.classList.add('text-red-500');
            }
        }

    </script>
</body>
</html>